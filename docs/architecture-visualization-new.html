<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Screener Architecture - Solar System Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --orchestrator-color: #ff6b6b;
            --orchestrator-glow: rgba(255, 107, 107, 0.6);
            --structure-color: #4ecdc4;
            --structure-glow: rgba(78, 205, 196, 0.5);
            --module-color: #45b7d1;
            --module-glow: rgba(69, 183, 209, 0.4);
            --shared-color: #f9ca24;
            --shared-glow: rgba(249, 202, 36, 0.5);
            --bg-dark: #0a0a1a;
            --bg-gradient-1: #0d1b2a;
            --bg-gradient-2: #1b263b;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: radial-gradient(ellipse at center, var(--bg-gradient-2) 0%, var(--bg-gradient-1) 50%, var(--bg-dark) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            text-align: center;
            padding: 16px 24px;
            background: linear-gradient(180deg, rgba(10, 10, 26, 0.95) 0%, rgba(10, 10, 26, 0.8) 70%, transparent 100%);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #4ecdc4 50%, #45b7d1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d9ff, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        #visualization {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .legend {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 20px 24px;
            border-radius: 16px;
            font-size: 13px;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .legend h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 14px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 6px 8px;
            border-radius: 8px;
            margin-left: -8px;
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 12px;
            box-shadow: 0 0 12px currentColor;
        }

        .legend-text {
            font-weight: 500;
        }

        .controls {
            position: fixed;
            top: 110px;
            right: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 16px;
            z-index: 100;
            min-width: 180px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .controls h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 14px;
            font-weight: 600;
        }

        .controls button {
            display: block;
            width: 100%;
            margin: 6px 0;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.25s ease;
            text-align: left;
        }

        .controls button:hover {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .controls button.active {
            background: linear-gradient(135deg, var(--structure-color), #3db8b0);
            color: #000;
            border-color: transparent;
            font-weight: 600;
            box-shadow: 0 4px 15px var(--structure-glow);
        }

        .collapse-controls {
            position: fixed;
            top: 110px;
            left: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 16px;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .collapse-controls h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 14px;
            font-weight: 600;
        }

        .collapse-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            margin: 6px 0;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.25s ease;
        }

        .collapse-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-primary);
        }

        .collapse-btn .icon {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .tooltip {
            position: fixed;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 18px 22px;
            font-size: 13px;
            pointer-events: none;
            max-width: 320px;
            z-index: 1000;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .tooltip h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tooltip .type-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .tooltip p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .tooltip .modules-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--glass-border);
        }

        .tooltip .modules-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .tooltip .module-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tooltip .module-tag {
            display: inline-flex;
            align-items: center;
            background: rgba(78, 205, 196, 0.15);
            color: var(--structure-color);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .tooltip .module-tag.shared {
            background: rgba(249, 202, 36, 0.2);
            color: var(--shared-color);
        }

        .tooltip .shared-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 10px 12px;
            background: rgba(249, 202, 36, 0.1);
            border-radius: 8px;
            color: var(--shared-color);
            font-size: 12px;
        }

        .help-text {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            z-index: 100;
            max-width: 220px;
            line-height: 1.5;
        }

        .help-text strong {
            color: var(--text-primary);
        }

        .node-group {
            cursor: pointer;
            transition: filter 0.3s ease;
        }

        .node-group:hover {
            filter: brightness(1.2);
        }

        .orbit-ring {
            fill: none;
            stroke: rgba(255, 255, 255, 0.05);
            stroke-width: 1;
            stroke-dasharray: 4 4;
        }

        .connection-line {
            stroke: rgba(255, 255, 255, 0.15);
            stroke-width: 1.5;
            transition: all 0.3s ease;
        }

        .connection-line.shared {
            stroke: var(--shared-color);
            stroke-width: 2;
            stroke-dasharray: 6 4;
            opacity: 0.6;
        }

        .connection-line.highlighted {
            stroke-width: 3;
            opacity: 1;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        @keyframes orbit-dash {
            to { stroke-dashoffset: -20; }
        }

        .orbit-ring {
            animation: orbit-dash 20s linear infinite;
        }

        .glow-effect {
            filter: url(#glow);
        }
    </style>
</head>
<body>
    <canvas class="stars" id="stars"></canvas>
    
    <div class="header">
        <h1>CV Screener Architecture</h1>
        <div class="stats">
            <div class="stat-item">
                <span class="stat-value">1</span>
                <span class="stat-label">Orchestrator</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">9</span>
                <span class="stat-label">Structures</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">25</span>
                <span class="stat-label">Modules</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">4</span>
                <span class="stat-label">Shared</span>
            </div>
        </div>
    </div>

    <div id="visualization"></div>

    <div class="collapse-controls">
        <h3>Visibility</h3>
        <button class="collapse-btn" onclick="toggleAllModules()">
            <span class="icon" id="toggle-icon">â—‰</span>
            <span id="toggle-text">Hide All Modules</span>
        </button>
        <button class="collapse-btn" onclick="expandAll()">
            <span class="icon">âŠ•</span>
            <span>Expand All</span>
        </button>
        <button class="collapse-btn" onclick="collapseAll()">
            <span class="icon">âŠ–</span>
            <span>Collapse All</span>
        </button>
        <button class="collapse-btn" onclick="resetView()">
            <span class="icon">â†»</span>
            <span>Reset View</span>
        </button>
    </div>

    <div class="legend">
        <h3>Node Types</h3>
        <div class="legend-item" onclick="highlightType('orchestrator')">
            <div class="legend-color" style="background: var(--orchestrator-color); color: var(--orchestrator-color);"></div>
            <span class="legend-text">Orchestrator</span>
        </div>
        <div class="legend-item" onclick="highlightType('structure')">
            <div class="legend-color" style="background: var(--structure-color); color: var(--structure-color);"></div>
            <span class="legend-text">Structures</span>
        </div>
        <div class="legend-item" onclick="highlightType('module')">
            <div class="legend-color" style="background: var(--module-color); color: var(--module-color);"></div>
            <span class="legend-text">Modules</span>
        </div>
        <div class="legend-item" onclick="highlightType('shared')">
            <div class="legend-color" style="background: var(--shared-color); color: var(--shared-color);"></div>
            <span class="legend-text">Shared Modules</span>
        </div>
    </div>

    <div class="controls">
        <h3>Filter View</h3>
        <button onclick="filterView('all')" class="active" id="btn-all">Show All</button>
        <button onclick="filterView('single_candidate')" id="btn-single_candidate">Single Candidate</button>
        <button onclick="filterView('risk_assessment')" id="btn-risk_assessment">Risk Assessment</button>
        <button onclick="filterView('comparison')" id="btn-comparison">Comparison</button>
        <button onclick="filterView('search')" id="btn-search">Search</button>
        <button onclick="filterView('ranking')" id="btn-ranking">Ranking</button>
        <button onclick="filterView('job_match')" id="btn-job_match">Job Match</button>
        <button onclick="filterView('team_build')" id="btn-team_build">Team Build</button>
        <button onclick="filterView('verification')" id="btn-verification">Verification</button>
        <button onclick="filterView('summary')" id="btn-summary">Summary</button>
    </div>

    <div class="help-text">
        <strong>Controls:</strong><br>
        â€¢ Click structures to toggle modules<br>
        â€¢ Drag nodes to reposition<br>
        â€¢ Scroll to zoom<br>
        â€¢ Drag background to pan
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Stars background
        const starsCanvas = document.getElementById('stars');
        const starsCtx = starsCanvas.getContext('2d');
        
        function initStars() {
            starsCanvas.width = window.innerWidth;
            starsCanvas.height = window.innerHeight;
            
            const stars = [];
            for (let i = 0; i < 200; i++) {
                stars.push({
                    x: Math.random() * starsCanvas.width,
                    y: Math.random() * starsCanvas.height,
                    radius: Math.random() * 1.5,
                    alpha: Math.random() * 0.8 + 0.2
                });
            }
            
            starsCtx.clearRect(0, 0, starsCanvas.width, starsCanvas.height);
            stars.forEach(star => {
                starsCtx.beginPath();
                starsCtx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                starsCtx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                starsCtx.fill();
            });
        }
        initStars();
        window.addEventListener('resize', initStars);

        // Architecture Data
        const architectureData = {
            orchestrator: {
                id: "orchestrator",
                name: "Orchestrator",
                description: "Routes queries to appropriate structures based on query_type",
                type: "orchestrator"
            },
            structures: [
                { id: "single_candidate", name: "SingleCandidate", description: "Complete candidate profile with all sections", modules: ["thinking", "highlights", "career", "skills", "credentials", "risk_table", "conclusion"] },
                { id: "risk_assessment", name: "RiskAssessment", description: "Risk-focused analysis with 5-factor table", modules: ["thinking", "risk_table", "conclusion"] },
                { id: "comparison", name: "Comparison", description: "Side-by-side comparison table + winner card", modules: ["thinking", "analysis", "table", "conclusion"] },
                { id: "search", name: "Search", description: "Search results with match scores", modules: ["thinking", "direct_answer", "analysis", "results_table", "conclusion"] },
                { id: "ranking", name: "Ranking", description: "Ordered ranking with #1 highlighted", modules: ["thinking", "analysis", "ranking_criteria", "ranking_table", "top_pick", "conclusion"] },
                { id: "job_match", name: "JobMatch", description: "Match percentages + requirements breakdown", modules: ["thinking", "analysis", "requirements", "match_score", "gap_analysis", "conclusion"] },
                { id: "team_build", name: "TeamBuild", description: "Team assignments + skill coverage + risks", modules: ["thinking", "analysis", "team_requirements", "team_composition", "skill_coverage", "team_risk", "conclusion"] },
                { id: "verification", name: "Verification", description: "Verification result (CONFIRMED/PARTIAL/NOT_FOUND)", modules: ["thinking", "claim", "evidence", "verdict", "conclusion"] },
                { id: "summary", name: "Summary", description: "Pool statistics + distributions", modules: ["thinking", "talent_pool", "skill_distribution", "experience_distribution", "conclusion"] }
            ],
            modules: {
                thinking: { name: "Thinking", description: "Extract :::thinking reasoning blocks", shared: true, usedBy: 9 },
                conclusion: { name: "Conclusion", description: "Extract :::conclusion final assessment", shared: true, usedBy: 9 },
                analysis: { name: "Analysis", description: "Extract analysis text between sections", shared: true, usedBy: 6 },
                risk_table: { name: "RiskTable", description: "5-factor risk assessment table", shared: true, usedBy: 2 },
                highlights: { name: "Highlights", description: "Key candidate info table", shared: false },
                career: { name: "Career", description: "Career trajectory timeline", shared: false },
                skills: { name: "Skills", description: "Categorized skills snapshot", shared: false },
                credentials: { name: "Credentials", description: "Certifications & education", shared: false },
                table: { name: "Table", description: "Candidate comparison table", shared: false },
                results_table: { name: "ResultsTable", description: "Search results table", shared: false },
                direct_answer: { name: "DirectAnswer", description: "Direct response to query", shared: false },
                ranking_criteria: { name: "RankingCriteria", description: "Extract/define ranking criteria", shared: false },
                ranking_table: { name: "RankingTable", description: "Ranked candidates table", shared: false },
                top_pick: { name: "TopPick", description: "#1 candidate recommendation", shared: false },
                requirements: { name: "Requirements", description: "Parse job description requirements", shared: false },
                match_score: { name: "MatchScore", description: "Calculate match percentages", shared: false },
                gap_analysis: { name: "GapAnalysis", description: "Identify skill/experience gaps", shared: false },
                team_requirements: { name: "TeamReqs", description: "Define team role requirements", shared: false },
                team_composition: { name: "TeamComp", description: "Assign candidates to roles", shared: false },
                skill_coverage: { name: "SkillCoverage", description: "Analyze team skill coverage", shared: false },
                team_risk: { name: "TeamRisk", description: "Identify team risks", shared: false },
                claim: { name: "Claim", description: "Parse verification claim", shared: false },
                evidence: { name: "Evidence", description: "Find supporting/contradicting evidence", shared: false },
                verdict: { name: "Verdict", description: "Issue CONFIRMED/PARTIAL/NOT_FOUND", shared: false },
                talent_pool: { name: "TalentPool", description: "Pool statistics", shared: false },
                skill_distribution: { name: "SkillDist", description: "Skill frequency analysis", shared: false },
                experience_distribution: { name: "ExpDist", description: "Experience level distribution", shared: false }
            }
        };

        // State
        let expandedStructures = new Set(architectureData.structures.map(s => s.id));
        let allModulesVisible = true;
        let currentFilter = 'all';

        // Setup
        const width = window.innerWidth;
        const height = window.innerHeight;
        const centerX = width / 2;
        const centerY = height / 2;

        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // Defs for gradients and filters
        const defs = svg.append("defs");

        // Glow filter
        const glowFilter = defs.append("filter")
            .attr("id", "glow")
            .attr("x", "-50%")
            .attr("y", "-50%")
            .attr("width", "200%")
            .attr("height", "200%");
        
        glowFilter.append("feGaussianBlur")
            .attr("stdDeviation", "4")
            .attr("result", "coloredBlur");
        
        const glowMerge = glowFilter.append("feMerge");
        glowMerge.append("feMergeNode").attr("in", "coloredBlur");
        glowMerge.append("feMergeNode").attr("in", "SourceGraphic");

        // Gradients
        const orchestratorGradient = defs.append("radialGradient")
            .attr("id", "orchestrator-gradient")
            .attr("cx", "30%")
            .attr("cy", "30%");
        orchestratorGradient.append("stop").attr("offset", "0%").attr("stop-color", "#ff8a8a");
        orchestratorGradient.append("stop").attr("offset", "100%").attr("stop-color", "#ff6b6b");

        const structureGradient = defs.append("radialGradient")
            .attr("id", "structure-gradient")
            .attr("cx", "30%")
            .attr("cy", "30%");
        structureGradient.append("stop").attr("offset", "0%").attr("stop-color", "#6ee7de");
        structureGradient.append("stop").attr("offset", "100%").attr("stop-color", "#4ecdc4");

        const moduleGradient = defs.append("radialGradient")
            .attr("id", "module-gradient")
            .attr("cx", "30%")
            .attr("cy", "30%");
        moduleGradient.append("stop").attr("offset", "0%").attr("stop-color", "#6bc9e0");
        moduleGradient.append("stop").attr("offset", "100%").attr("stop-color", "#45b7d1");

        const sharedGradient = defs.append("radialGradient")
            .attr("id", "shared-gradient")
            .attr("cx", "30%")
            .attr("cy", "30%");
        sharedGradient.append("stop").attr("offset", "0%").attr("stop-color", "#fcd757");
        sharedGradient.append("stop").attr("offset", "100%").attr("stop-color", "#f9ca24");

        // Main container group
        const mainGroup = svg.append("g").attr("class", "main-group");

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.3, 2.5])
            .on("zoom", (event) => {
                mainGroup.attr("transform", event.transform);
            });
        svg.call(zoom);

        // Initial transform
        svg.call(zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1));

        // Layers
        const orbitLayer = mainGroup.append("g").attr("class", "orbit-layer");
        const connectionLayer = mainGroup.append("g").attr("class", "connection-layer");
        const nodeLayer = mainGroup.append("g").attr("class", "node-layer");

        // Tooltip
        const tooltip = document.getElementById('tooltip');

        function showTooltip(event, data) {
            let typeColor, typeName;
            if (data.type === 'orchestrator') {
                typeColor = 'var(--orchestrator-color)';
                typeName = 'Orchestrator';
            } else if (data.type === 'structure') {
                typeColor = 'var(--structure-color)';
                typeName = 'Structure';
            } else if (data.shared) {
                typeColor = 'var(--shared-color)';
                typeName = 'Shared Module';
            } else {
                typeColor = 'var(--module-color)';
                typeName = 'Module';
            }

            let html = `
                <h3>
                    ${data.name}
                    <span class="type-badge" style="background: ${typeColor}20; color: ${typeColor}">${typeName}</span>
                </h3>
                <p>${data.description}</p>
            `;

            if (data.modules && data.modules.length > 0) {
                html += `
                    <div class="modules-section">
                        <div class="modules-label">Modules (${data.modules.length})</div>
                        <div class="module-tags">
                            ${data.modules.map(m => {
                                const mod = architectureData.modules[m];
                                const isShared = mod && mod.shared;
                                return `<span class="module-tag ${isShared ? 'shared' : ''}">${mod ? mod.name : m}</span>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            if (data.shared && data.usedBy) {
                html += `
                    <div class="shared-info">
                        <span>ðŸ”„</span>
                        <span>Shared across ${data.usedBy} structures</span>
                    </div>
                `;
            }

            tooltip.innerHTML = html;
            tooltip.style.left = (event.pageX + 20) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            tooltip.classList.remove('visible');
        }

        // Calculate positions
        const structureOrbitRadius = Math.min(width, height) * 0.28;
        const moduleOrbitRadius = 85;

        function calculatePositions() {
            const positions = {
                orchestrator: { x: centerX, y: centerY, fx: centerX, fy: centerY },
                structures: {},
                modules: {}
            };

            // Structure positions in orbit around orchestrator
            const structureCount = architectureData.structures.length;
            architectureData.structures.forEach((structure, i) => {
                const angle = (i / structureCount) * 2 * Math.PI - Math.PI / 2;
                positions.structures[structure.id] = {
                    x: centerX + Math.cos(angle) * structureOrbitRadius,
                    y: centerY + Math.sin(angle) * structureOrbitRadius,
                    angle: angle
                };

                // Module positions in orbit around structure
                const moduleCount = structure.modules.length;
                structure.modules.forEach((moduleId, j) => {
                    const moduleAngle = (j / moduleCount) * 2 * Math.PI - Math.PI / 2;
                    const structPos = positions.structures[structure.id];
                    
                    if (!positions.modules[moduleId]) {
                        positions.modules[moduleId] = [];
                    }
                    
                    positions.modules[moduleId].push({
                        structureId: structure.id,
                        x: structPos.x + Math.cos(moduleAngle) * moduleOrbitRadius,
                        y: structPos.y + Math.sin(moduleAngle) * moduleOrbitRadius,
                        angle: moduleAngle
                    });
                });
            });

            return positions;
        }

        let positions = calculatePositions();

        // Draw orbit rings
        function drawOrbits() {
            orbitLayer.selectAll("*").remove();

            // Main orbit ring
            orbitLayer.append("circle")
                .attr("class", "orbit-ring")
                .attr("cx", centerX)
                .attr("cy", centerY)
                .attr("r", structureOrbitRadius);

            // Structure orbit rings (for modules)
            architectureData.structures.forEach(structure => {
                if (expandedStructures.has(structure.id)) {
                    const pos = positions.structures[structure.id];
                    orbitLayer.append("circle")
                        .attr("class", "orbit-ring")
                        .attr("cx", pos.x)
                        .attr("cy", pos.y)
                        .attr("r", moduleOrbitRadius)
                        .style("opacity", 0.5);
                }
            });
        }

        // Draw connections
        function drawConnections() {
            connectionLayer.selectAll("*").remove();

            // Orchestrator to structures
            architectureData.structures.forEach(structure => {
                const structPos = positions.structures[structure.id];
                connectionLayer.append("line")
                    .attr("class", "connection-line")
                    .attr("data-source", "orchestrator")
                    .attr("data-target", structure.id)
                    .attr("x1", centerX)
                    .attr("y1", centerY)
                    .attr("x2", structPos.x)
                    .attr("y2", structPos.y);
            });

            // Structures to modules
            architectureData.structures.forEach(structure => {
                if (!expandedStructures.has(structure.id)) return;
                
                const structPos = positions.structures[structure.id];
                structure.modules.forEach((moduleId, idx) => {
                    const mod = architectureData.modules[moduleId];
                    const modulePositions = positions.modules[moduleId];
                    const modulePos = modulePositions.find(p => p.structureId === structure.id);
                    
                    if (modulePos) {
                        connectionLayer.append("line")
                            .attr("class", `connection-line ${mod.shared ? 'shared' : ''}`)
                            .attr("data-source", structure.id)
                            .attr("data-target", moduleId)
                            .attr("x1", structPos.x)
                            .attr("y1", structPos.y)
                            .attr("x2", modulePos.x)
                            .attr("y2", modulePos.y);
                    }
                });
            });
        }

        // Drag behavior
        function createDrag() {
            return d3.drag()
                .on("start", function(event) {
                    d3.select(this).raise();
                })
                .on("drag", function(event, d) {
                    d.x = event.x;
                    d.y = event.y;
                    d3.select(this).attr("transform", `translate(${d.x}, ${d.y})`);
                    
                    // Update connections
                    if (d.type === 'orchestrator') {
                        connectionLayer.selectAll(`line[data-source="orchestrator"]`)
                            .attr("x1", d.x)
                            .attr("y1", d.y);
                    } else if (d.type === 'structure') {
                        connectionLayer.selectAll(`line[data-target="${d.id}"]`)
                            .attr("x2", d.x)
                            .attr("y2", d.y);
                        connectionLayer.selectAll(`line[data-source="${d.id}"]`)
                            .attr("x1", d.x)
                            .attr("y1", d.y);
                    } else {
                        connectionLayer.selectAll(`line[data-target="${d.id}"][data-source="${d.parentId}"]`)
                            .attr("x2", d.x)
                            .attr("y2", d.y);
                    }
                });
        }

        // Draw nodes
        function drawNodes() {
            nodeLayer.selectAll("*").remove();

            // Draw Orchestrator
            const orchestratorGroup = nodeLayer.append("g")
                .attr("class", "node-group orchestrator")
                .datum({ ...architectureData.orchestrator, x: centerX, y: centerY })
                .attr("transform", `translate(${centerX}, ${centerY})`)
                .call(createDrag())
                .on("mouseover", function(event, d) { showTooltip(event, d); })
                .on("mouseout", hideTooltip);

            orchestratorGroup.append("circle")
                .attr("r", 55)
                .attr("fill", "url(#orchestrator-gradient)")
                .attr("opacity", 0.2)
                .attr("filter", "url(#glow)");

            orchestratorGroup.append("circle")
                .attr("r", 45)
                .attr("fill", "url(#orchestrator-gradient)")
                .attr("stroke", "rgba(255,255,255,0.4)")
                .attr("stroke-width", 2)
                .attr("filter", "url(#glow)");

            orchestratorGroup.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "-5")
                .attr("font-size", "20px")
                .text("ðŸŽ¯");

            orchestratorGroup.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "18")
                .attr("fill", "white")
                .attr("font-size", "11px")
                .attr("font-weight", "600")
                .text("Orchestrator");

            // Draw Structures
            architectureData.structures.forEach(structure => {
                const pos = positions.structures[structure.id];
                const isExpanded = expandedStructures.has(structure.id);
                
                const structureGroup = nodeLayer.append("g")
                    .attr("class", "node-group structure")
                    .datum({ ...structure, type: 'structure', x: pos.x, y: pos.y })
                    .attr("transform", `translate(${pos.x}, ${pos.y})`)
                    .call(createDrag())
                    .on("click", function(event, d) {
                        event.stopPropagation();
                        toggleStructure(d.id);
                    })
                    .on("mouseover", function(event, d) { showTooltip(event, d); })
                    .on("mouseout", hideTooltip);

                structureGroup.append("circle")
                    .attr("r", 40)
                    .attr("fill", "url(#structure-gradient)")
                    .attr("opacity", 0.15)
                    .attr("filter", "url(#glow)");

                structureGroup.append("circle")
                    .attr("r", 32)
                    .attr("fill", "url(#structure-gradient)")
                    .attr("stroke", isExpanded ? "rgba(255,255,255,0.5)" : "rgba(255,255,255,0.2)")
                    .attr("stroke-width", isExpanded ? 3 : 2)
                    .attr("filter", "url(#glow)");

                structureGroup.append("circle")
                    .attr("cx", 22)
                    .attr("cy", -22)
                    .attr("r", 10)
                    .attr("fill", isExpanded ? "#4ecdc4" : "#2a3a4a")
                    .attr("stroke", "rgba(255,255,255,0.3)")
                    .attr("stroke-width", 1);

                structureGroup.append("text")
                    .attr("x", 22)
                    .attr("y", -18)
                    .attr("text-anchor", "middle")
                    .attr("fill", "white")
                    .attr("font-size", "12px")
                    .attr("font-weight", "bold")
                    .text(isExpanded ? "âˆ’" : "+");

                structureGroup.append("circle")
                    .attr("cx", -22)
                    .attr("cy", -22)
                    .attr("r", 12)
                    .attr("fill", "#1a2a3a")
                    .attr("stroke", "rgba(255,255,255,0.2)")
                    .attr("stroke-width", 1);

                structureGroup.append("text")
                    .attr("x", -22)
                    .attr("y", -18)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#4ecdc4")
                    .attr("font-size", "10px")
                    .attr("font-weight", "bold")
                    .text(structure.modules.length);

                structureGroup.append("text")
                    .attr("text-anchor", "middle")
                    .attr("dy", "5")
                    .attr("fill", "white")
                    .attr("font-size", "10px")
                    .attr("font-weight", "600")
                    .text(structure.name.length > 12 ? structure.name.substring(0, 11) + '..' : structure.name);
            });

            // Draw Modules
            architectureData.structures.forEach(structure => {
                if (!expandedStructures.has(structure.id)) return;

                structure.modules.forEach((moduleId, idx) => {
                    const mod = architectureData.modules[moduleId];
                    const modulePositions = positions.modules[moduleId];
                    const modulePos = modulePositions.find(p => p.structureId === structure.id);
                    
                    if (!modulePos) return;

                    const moduleGroup = nodeLayer.append("g")
                        .attr("class", `node-group module ${mod.shared ? 'shared' : ''}`)
                        .datum({ 
                            id: moduleId, 
                            parentId: structure.id,
                            ...mod, 
                            type: 'module', 
                            x: modulePos.x, 
                            y: modulePos.y 
                        })
                        .attr("transform", `translate(${modulePos.x}, ${modulePos.y})`)
                        .call(createDrag())
                        .on("mouseover", function(event, d) { showTooltip(event, d); })
                        .on("mouseout", hideTooltip);

                    const gradient = mod.shared ? "url(#shared-gradient)" : "url(#module-gradient)";

                    if (mod.shared) {
                        moduleGroup.append("circle")
                            .attr("r", 24)
                            .attr("fill", gradient)
                            .attr("opacity", 0.15)
                            .attr("filter", "url(#glow)");
                    }

                    moduleGroup.append("circle")
                        .attr("r", 18)
                        .attr("fill", gradient)
                        .attr("stroke", mod.shared ? "rgba(249,202,36,0.5)" : "rgba(255,255,255,0.25)")
                        .attr("stroke-width", mod.shared ? 2 : 1.5)
                        .attr("filter", mod.shared ? "url(#glow)" : "none");

                    moduleGroup.append("text")
                        .attr("text-anchor", "middle")
                        .attr("dy", "4")
                        .attr("fill", mod.shared ? "#1a1a2a" : "white")
                        .attr("font-size", "8px")
                        .attr("font-weight", mod.shared ? "700" : "500")
                        .text(mod.name.length > 8 ? mod.name.substring(0, 7) + '..' : mod.name);
                });
            });
        }

        function toggleStructure(structureId) {
            if (expandedStructures.has(structureId)) {
                expandedStructures.delete(structureId);
            } else {
                expandedStructures.add(structureId);
            }
            render();
        }

        function toggleAllModules() {
            allModulesVisible = !allModulesVisible;
            if (allModulesVisible) {
                expandedStructures = new Set(architectureData.structures.map(s => s.id));
                document.getElementById('toggle-icon').textContent = 'â—‰';
                document.getElementById('toggle-text').textContent = 'Hide All Modules';
            } else {
                expandedStructures.clear();
                document.getElementById('toggle-icon').textContent = 'â—Ž';
                document.getElementById('toggle-text').textContent = 'Show All Modules';
            }
            render();
        }

        function expandAll() {
            expandedStructures = new Set(architectureData.structures.map(s => s.id));
            allModulesVisible = true;
            document.getElementById('toggle-icon').textContent = 'â—‰';
            document.getElementById('toggle-text').textContent = 'Hide All Modules';
            render();
        }

        function collapseAll() {
            expandedStructures.clear();
            allModulesVisible = false;
            document.getElementById('toggle-icon').textContent = 'â—Ž';
            document.getElementById('toggle-text').textContent = 'Show All Modules';
            render();
        }

        function resetView() {
            positions = calculatePositions();
            expandedStructures = new Set(architectureData.structures.map(s => s.id));
            allModulesVisible = true;
            currentFilter = 'all';
            document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-all').classList.add('active');
            document.getElementById('toggle-icon').textContent = 'â—‰';
            document.getElementById('toggle-text').textContent = 'Hide All Modules';
            svg.call(zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1));
            render();
        }

        function highlightType(type) {
            nodeLayer.selectAll(".node-group").style("opacity", function(d) {
                if (type === 'shared') {
                    return d.shared ? 1 : 0.2;
                }
                return d.type === type || (type === 'module' && d.type === 'module' && !d.shared) ? 1 : 0.2;
            });
            
            connectionLayer.selectAll(".connection-line").style("opacity", 0.1);
            
            setTimeout(() => {
                nodeLayer.selectAll(".node-group").style("opacity", 1);
                connectionLayer.selectAll(".connection-line").style("opacity", 1);
            }, 2000);
        }

        function filterView(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + filter).classList.add('active');

            if (filter === 'all') {
                nodeLayer.selectAll(".node-group")
                    .transition().duration(300)
                    .style("opacity", 1);
                connectionLayer.selectAll(".connection-line")
                    .transition().duration(300)
                    .style("opacity", 1);
                return;
            }

            const structure = architectureData.structures.find(s => s.id === filter);
            if (!structure) return;

            const relevantModules = structure.modules;

            nodeLayer.selectAll(".node-group")
                .transition().duration(300)
                .style("opacity", function(d) {
                    if (d.type === 'orchestrator') return 1;
                    if (d.id === filter) return 1;
                    if (relevantModules.includes(d.id) && d.parentId === filter) return 1;
                    return 0.1;
                });

            connectionLayer.selectAll(".connection-line")
                .transition().duration(300)
                .style("opacity", function() {
                    const source = this.getAttribute('data-source');
                    const target = this.getAttribute('data-target');
                    if (source === 'orchestrator' && target === filter) return 1;
                    if (source === filter) return 1;
                    return 0.05;
                });
        }

        function render() {
            drawOrbits();
            drawConnections();
            drawNodes();
            
            if (currentFilter !== 'all') {
                filterView(currentFilter);
            }
        }

        render();
    </script>
</body>
</html>
